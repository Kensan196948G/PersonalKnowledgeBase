# OneNote インポートガイド

## 概要

Personal Knowledge BaseシステムへOneNoteのデータをインポートする方法を説明します。

OneNoteから複数の形式でエクスポートし、それぞれを本システムにインポートできます。

## 対応フォーマット

| 形式 | 拡張子 | 推奨度 | 特徴 | 制限事項 |
|------|--------|--------|------|----------|
| **HTML** | `.html`, `.htm` | ★★★★★ | 書式・構造の保持が最も良好 | 画像は別ファイルとして扱う必要あり |
| **MHT/MHTML** | `.mht`, `.mhtml` | ★★★★☆ | 単一ファイルで完結、画像埋め込み可能 | 一部書式が失われる可能性あり |
| **DOCX** | `.docx` | ★★★☆☆ | Word形式、書式保持良好 | リンク・表は変換精度が落ちる |
| **PDF** | `.pdf` | ★★☆☆☆ | 閲覧用、テキストのみ抽出 | 書式・構造はすべて失われる |
| **ONEPKG** | `.onepkg` | ★☆☆☆☆ | ノートブック全体、構造解析のみ | 直接インポート不可、ガイド作成のみ |

## OneNoteからのエクスポート手順

### 1. ページ単位のエクスポート（推奨）

単一のページを個別にエクスポートする方法。

#### HTML形式（最も推奨）

1. OneNoteで対象のページを開く
2. 「ファイル」→「エクスポート」を選択
3. 「現在のページ」を選択
4. 形式として「Webページ (.html)」を選択
5. 保存先を指定してエクスポート

#### MHT/MHTML形式（推奨）

1. OneNoteで対象のページを開く
2. 「ファイル」→「エクスポート」を選択
3. 「現在のページ」を選択
4. 形式として「単一ファイルWebページ (.mht)」または「Webアーカイブ、単一ファイル (.mhtml)」を選択
5. 保存先を指定してエクスポート

#### DOCX形式

1. OneNoteで対象のページを開く
2. 「ファイル」→「エクスポート」を選択
3. 「現在のページ」を選択
4. 形式として「Word文書 (.docx)」を選択
5. 保存先を指定してエクスポート

#### PDF形式

1. OneNoteで対象のページを開く
2. 「ファイル」→「エクスポート」を選択
3. 「現在のページ」を選択
4. 形式として「PDF (.pdf)」を選択
5. 保存先を指定してエクスポート

### 2. セクション単位のエクスポート

複数のページを含むセクション全体をエクスポートする方法。

1. OneNoteでセクションを右クリック
2. 「エクスポート」を選択
3. 形式を選択（HTML, DOCX, PDFなど）
4. 保存先を指定してエクスポート
5. 各ページが個別ファイルとしてエクスポートされる
6. 各ファイルを個別にインポート

### 3. ノートブック単位のエクスポート

ノートブック全体をエクスポートする方法。

#### ONEPKG形式

1. OneNoteでノートブックを右クリック
2. 「エクスポート」を選択
3. 「OneNoteパッケージ (.onepkg)」を選択
4. 保存先を指定してエクスポート

**注意**: ONEPKGファイルは直接インポートできません。本システムでは構造解析してガイドノートを作成します。実際のインポートは、各セクションを個別にHTML形式でエクスポートしてください。

## Personal Knowledge Baseへのインポート

### インポート手順

1. Personal Knowledge Baseを起動
2. ヘッダーの「インポート」ボタンをクリック
3. インポートダイアログで形式を選択
   - HTML
   - MHT
   - DOCX
   - PDF
   - ONEPKG
4. ファイルをドラッグ&ドロップ、またはクリックして選択
5. オプション設定
   - 「"OneNote Import"タグを追加」: インポート元を識別するタグを自動付与
6. 「インポート実行」ボタンをクリック
7. インポート完了後、ノートが作成される

### インポート後の処理

- タイトルは自動抽出（h1タグ、titleタグ、またはファイル名）
- 本文はTipTapエディタ形式に変換
- OneNote固有のスタイル（mso-*）は自動削除
- インポートタグを有効にした場合、自動的にタグが付与される

### サポートされる要素

すべての形式で以下の要素が変換されます:

- 見出し（h1-h6）
- 段落（p）
- リスト（ul, ol）
- タスクリスト（チェックボックス）
- リンク（a）
- テキストスタイル（太字、斜体、下線、取り消し線）

## トラブルシューティング

### 文字化けが発生する

**原因**: OneNoteのエクスポート時の文字コードが正しく処理されていない可能性があります。

**対処法**:
- MHT形式でエクスポートし直す（文字コード自動検出機能が動作）
- HTML形式の場合、UTF-8でエクスポートされているか確認

### 画像がインポートされない

**原因**: Phase 1では画像のインポート機能は未実装です。

**対処法**:
- テキスト情報のみインポートされます
- 画像は別途、Personal Knowledge Baseのエディタで手動で貼り付けてください
- 将来のPhaseで画像インポート機能が追加される予定です

### ONEPKGファイルがインポートできない

**原因**: ONEPKGファイルは独自のバイナリ形式のため、直接変換できません。

**対処法**:
1. ONEPKGをインポートすると、構造解析されたガイドノートが作成されます
2. ガイドノートに記載された手順に従い、各セクションをHTML形式で個別にエクスポート
3. エクスポートしたHTMLファイルを個別にインポート

### ファイルサイズエラーが出る

**原因**: ファイルサイズが制限を超えています。

**制限サイズ**:
- HTML: 10MB
- MHT/MHTML: 20MB
- DOCX: 20MB
- PDF: 30MB
- ONEPKG: 100MB

**対処法**:
- 大きなノートは分割してエクスポート
- 画像が多い場合、画像を除外してエクスポート

### 書式が崩れる

**原因**: OneNote固有の書式がTipTapエディタで対応していない可能性があります。

**対処法**:
- HTML形式が最も書式保持率が高いため、HTML形式を使用
- インポート後、手動で調整
- 複雑な表やレイアウトはシンプルな形式に変換される

## 推奨ワークフロー

### 単一ページの移行

1. OneNoteでページを開く
2. HTML形式でエクスポート
3. Personal Knowledge Baseでインポート
4. 必要に応じてタグやフォルダを整理

### 大量ページの移行

1. OneNoteでセクションまたはノートブック全体をエクスポート
2. 各ページのHTMLファイルが生成される
3. Personal Knowledge Baseで1つずつインポート
4. インポート時に「"OneNote Import"タグを追加」を有効化
5. インポート後、タグフィルターで一括確認・整理

### バックアップからの復元

1. バックアップからONEPKGファイルを取得
2. Personal Knowledge BaseでONEPKGをインポート
3. 生成されたガイドノートを確認
4. 各セクションをOneNoteでHTML形式にエクスポート
5. Personal Knowledge Baseで個別にインポート

## API仕様（開発者向け）

### エンドポイント

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| `/api/import/onenote` | POST | HTML形式のインポート |
| `/api/import/mht` | POST | MHT/MHTML形式のインポート |
| `/api/import/docx` | POST | DOCX形式のインポート |
| `/api/import/pdf` | POST | PDF形式のインポート |
| `/api/import/onepkg` | POST | ONEPKG構造解析（ガイド作成） |

### リクエスト形式

```http
POST /api/import/onenote
Content-Type: multipart/form-data

htmlFile: <File>
options: {"addImportTag": true}
```

### レスポンス形式

```json
{
  "success": true,
  "data": {
    "noteId": "abc123",
    "title": "インポートされたノート",
    "warnings": []
  }
}
```

### エラーレスポンス

```json
{
  "success": false,
  "error": "Failed to import OneNote file",
  "message": "詳細なエラーメッセージ"
}
```

## 技術的な詳細

### 文字コード対応

- UTF-8, Shift-JIS, EUC-JP, ISO-2022-JPを自動検出
- `charset-detector`と`iconv-lite`で変換処理

### HTML変換処理

1. HTMLをjsdomでパース
2. OneNote固有スタイル（mso-*）を削除
3. TipTap拡張機能（StarterKit, Link, TaskList, TaskItem）を使用してJSON変換
4. データベースに保存

### MHT変換処理

1. MHTファイルをバイナリで読み込み
2. Quoted-Printableデコード（UTF-8マルチバイト対応）
3. HTMLコンテンツを抽出
4. 以降はHTML変換と同様

### DOCX変換処理

1. DOCXファイルを読み込み
2. `mammoth`ライブラリでHTML変換
3. 以降はHTML変換と同様

### PDF変換処理

1. PDFファイルを読み込み
2. `pdf-parse`でテキスト抽出
3. 段落ごとに分割してTipTap JSON形式に変換
4. データベースに保存

### ONEPKG解析処理

1. ZIPとして解凍
2. .oneファイルを列挙
3. ガイドノート（インポート手順付き）を作成

## 依存ライブラリ

| ライブラリ | 用途 | バージョン |
|------------|------|------------|
| `jsdom` | HTML/DOM解析 | ^27.3.0 |
| `mammoth` | DOCX → HTML変換 | ^1.11.0 |
| `pdf-parse` | PDF → テキスト抽出 | ^2.4.5 |
| `adm-zip` | ONEPKG（ZIP）解凍 | ^0.5.16 |
| `charset-detector` | 文字コード自動検出 | ^0.0.2 |
| `iconv-lite` | 文字コード変換 | ^0.7.1 |
| `@tiptap/html` | HTML → TipTap JSON変換 | ^2.27.1 |

**注意**: `mhtml-parser`はpackage.jsonに含まれていますが、実際には使用されていません。独自実装のMHTパーサーを使用しています。

## 将来の拡張予定

- [ ] 画像の自動インポート（HTML形式）
- [ ] MHTファイル内の埋め込み画像抽出
- [ ] バッチインポート機能（複数ファイル一括）
- [ ] インポート進捗表示
- [ ] インポートプレビュー機能
- [ ] フォルダ構造の自動再現
- [ ] Evernote形式（.enex）対応
- [ ] Notion形式対応

## 関連ドキュメント

- [API_UPLOAD.md](/mnt/LinuxHDD/PersonalKnowledgeBase/docs/API_UPLOAD.md) - アップロードAPI仕様
- [インポート（Import）](/mnt/LinuxHDD/PersonalKnowledgeBase/docs/07_出力可搬性（Export）/インポート（Import）.md) - インポート機能の全体設計
- [Backend Services README](/mnt/LinuxHDD/PersonalKnowledgeBase/src/backend/services/README.md) - OneNoteインポーターサービス詳細

---

**最終更新**: 2025-12-14
**対象バージョン**: Phase 2 完了後
**ステータス**: 実装完了・本番利用可能
