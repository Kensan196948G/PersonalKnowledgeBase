# ===========================================
# è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# - 30åˆ†é–“éš”ã§è‡ªå‹•å®Ÿè¡Œ
# - ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ â†’ è‡ªå‹•ä¿®å¾© â†’ ç¢ºèªã‚’æœ€å¤§15å›ãƒ«ãƒ¼ãƒ—
# - ç„¡é™å®Ÿè¡Œï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
# ===========================================

name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ä¿®å¾©

on:
  # 30åˆ†é–“éš”ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  schedule:
    - cron: '*/30 * * * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '15'
        type: string
  # Pushæ™‚ã«ã‚‚å®Ÿè¡Œ
  push:
    branches: [main, feature/*]
  # PRæ™‚ã«ã‚‚å®Ÿè¡Œ
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  MAX_REPAIR_LOOPS: ${{ github.event.inputs.max_loops || '15' }}

jobs:
  error-detection-repair:
    name: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Prisma ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
        run: npx prisma generate

      - name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—
        id: repair_loop
        env:
          DATABASE_URL: file:./test.db
        run: |
          #!/bin/bash
          set -e

          MAX_LOOPS=${{ env.MAX_REPAIR_LOOPS }}
          LOOP_COUNT=0
          ERRORS_FOUND=true
          REPAIRS_MADE=false
          ERROR_LOG=""

          echo "============================================="
          echo "  è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—é–‹å§‹"
          echo "  æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°: $MAX_LOOPS"
          echo "============================================="

          while [ "$ERRORS_FOUND" = true ] && [ $LOOP_COUNT -lt $MAX_LOOPS ]; do
            LOOP_COUNT=$((LOOP_COUNT + 1))
            ERRORS_FOUND=false
            CURRENT_ERRORS=""

            echo ""
            echo "=== ãƒ«ãƒ¼ãƒ— $LOOP_COUNT / $MAX_LOOPS ==="
            echo ""

            # 1. ESLint ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
            echo "ğŸ“‹ ESLint ãƒã‚§ãƒƒã‚¯ä¸­..."
            if ! npm run lint 2>&1; then
              echo "âš ï¸ ESLint ã‚¨ãƒ©ãƒ¼æ¤œå‡º - è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œ"
              ERRORS_FOUND=true
              CURRENT_ERRORS="$CURRENT_ERRORS\n- ESLintã‚¨ãƒ©ãƒ¼"

              # è‡ªå‹•ä¿®å¾©
              npm run lint:fix 2>&1 || true
              REPAIRS_MADE=true
              echo "âœ… ESLint è‡ªå‹•ä¿®å¾©å®Œäº†"
            else
              echo "âœ… ESLint OK"
            fi

            # 2. TypeScript å‹ãƒã‚§ãƒƒã‚¯
            echo ""
            echo "ğŸ“‹ TypeScript å‹ãƒã‚§ãƒƒã‚¯ä¸­..."
            if ! npm run typecheck 2>&1; then
              echo "âš ï¸ TypeScript ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
              ERRORS_FOUND=true
              CURRENT_ERRORS="$CURRENT_ERRORS\n- TypeScriptã‚¨ãƒ©ãƒ¼"
              ERROR_LOG="$ERROR_LOG\n[ãƒ«ãƒ¼ãƒ—$LOOP_COUNT] TypeScriptã‚¨ãƒ©ãƒ¼æ¤œå‡º"
            else
              echo "âœ… TypeScript OK"
            fi

            # 3. Prettier ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
            echo ""
            echo "ğŸ“‹ Prettier ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ä¸­..."
            if ! npx prettier --check "src/**/*.{ts,tsx,json,css}" 2>&1; then
              echo "âš ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼æ¤œå‡º - è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œ"
              ERRORS_FOUND=true
              CURRENT_ERRORS="$CURRENT_ERRORS\n- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼"

              # è‡ªå‹•ä¿®å¾©
              npm run format 2>&1 || true
              REPAIRS_MADE=true
              echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè‡ªå‹•ä¿®å¾©å®Œäº†"
            else
              echo "âœ… Prettier OK"
            fi

            # 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            echo ""
            echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
            if ! npm test -- --passWithNoTests 2>&1; then
              echo "âš ï¸ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼æ¤œå‡º"
              ERRORS_FOUND=true
              CURRENT_ERRORS="$CURRENT_ERRORS\n- ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼"
              ERROR_LOG="$ERROR_LOG\n[ãƒ«ãƒ¼ãƒ—$LOOP_COUNT] ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼æ¤œå‡º"
            else
              echo "âœ… ãƒ†ã‚¹ãƒˆ OK"
            fi

            # 5. ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
            echo ""
            echo "ğŸ“‹ ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ä¸­..."
            if ! npm run build 2>&1; then
              echo "âš ï¸ ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
              ERRORS_FOUND=true
              CURRENT_ERRORS="$CURRENT_ERRORS\n- ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼"
              ERROR_LOG="$ERROR_LOG\n[ãƒ«ãƒ¼ãƒ—$LOOP_COUNT] ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
            else
              echo "âœ… ãƒ“ãƒ«ãƒ‰ OK"
            fi

            # ãƒ«ãƒ¼ãƒ—çµæœã‚µãƒãƒªãƒ¼
            if [ "$ERRORS_FOUND" = true ]; then
              echo ""
              echo "âš ï¸ ãƒ«ãƒ¼ãƒ— $LOOP_COUNT: ã‚¨ãƒ©ãƒ¼ã‚ã‚Š"
              echo -e "æ¤œå‡ºã‚¨ãƒ©ãƒ¼: $CURRENT_ERRORS"
            else
              echo ""
              echo "âœ… ãƒ«ãƒ¼ãƒ— $LOOP_COUNT: å…¨ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¹ï¼"
              break
            fi

            # çŸ­ã„å¾…æ©Ÿï¼ˆé€£ç¶šå®Ÿè¡Œã‚’é¿ã‘ã‚‹ï¼‰
            if [ $LOOP_COUNT -lt $MAX_LOOPS ] && [ "$ERRORS_FOUND" = true ]; then
              echo "â³ 5ç§’å¾…æ©Ÿå¾Œã€æ¬¡ã®ãƒ«ãƒ¼ãƒ—ã¸..."
              sleep 5
            fi
          done

          # æœ€çµ‚çµæœ
          echo ""
          echo "============================================="
          echo "  è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Œäº†"
          echo "============================================="
          echo "ç·ãƒ«ãƒ¼ãƒ—å›æ•°: $LOOP_COUNT"
          echo "ä¿®å¾©å®Ÿè¡Œ: $REPAIRS_MADE"
          echo "æœ€çµ‚çŠ¶æ…‹: $([ "$ERRORS_FOUND" = true ] && echo 'ã‚¨ãƒ©ãƒ¼ã‚ã‚Š' || echo 'å…¨ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¹')"

          # å‡ºåŠ›å¤‰æ•°è¨­å®š
          echo "loop_count=$LOOP_COUNT" >> $GITHUB_OUTPUT
          echo "repairs_made=$REPAIRS_MADE" >> $GITHUB_OUTPUT
          echo "final_status=$([ "$ERRORS_FOUND" = true ] && echo 'error' || echo 'success')" >> $GITHUB_OUTPUT

          # ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
          if [ "$ERRORS_FOUND" = true ]; then
            exit 1
          fi

      - name: ä¿®å¾©å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.repair_loop.outputs.repairs_made == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --quiet && git diff --staged --quiet; then
            echo "å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            git add -A
            git commit -m "fix: è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾© (ãƒ«ãƒ¼ãƒ— ${{ steps.repair_loop.outputs.loop_count }}å›)

            ğŸ¤– GitHub Actions ã«ã‚ˆã‚‹è‡ªå‹•ä¿®å¾©
            - ESLintè‡ªå‹•ä¿®å¾©
            - Prettierãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£

            Generated by: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"
            git push
            echo "âœ… ä¿®å¾©å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: ã‚¨ãƒ©ãƒ¼æ™‚Issueä½œæˆ
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const loopCount = '${{ steps.repair_loop.outputs.loop_count }}' || 'ä¸æ˜';
            const today = new Date().toISOString().split('T')[0];

            // æ—¢å­˜ã®ã‚ªãƒ¼ãƒ—ãƒ³Issueã‚’ç¢ºèª
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-repair,bug'
            });

            const todayIssue = existingIssues.data.find(issue =>
              issue.title.includes(today)
            );

            if (todayIssue) {
              // æ—¢å­˜Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `## è‡ªå‹•ä¿®å¾©å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ (${new Date().toLocaleString('ja-JP')})\n\n` +
                      `- **ãƒ«ãƒ¼ãƒ—å›æ•°**: ${loopCount}å›\n` +
                      `- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                      `æœ€å¤§${loopCount}å›ã®ãƒ«ãƒ¼ãƒ—ã§ã‚‚è§£æ±ºã§ããªã„ã‚¨ãƒ©ãƒ¼ãŒå­˜åœ¨ã—ã¾ã™ã€‚æ‰‹å‹•ç¢ºèªãŒå¿…è¦ã§ã™ã€‚`
              });
              console.log(`æ—¢å­˜Issue #${todayIssue.number} ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ `);
            } else {
              // æ–°è¦Issueä½œæˆ
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[è‡ªå‹•æ¤œçŸ¥] ã‚¨ãƒ©ãƒ¼ä¿®å¾©å¤±æ•— - ${today}`,
                body: `## è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ\n\n` +
                      `### æ¦‚è¦\n` +
                      `è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°ã«é”ã—ã¦ã‚‚å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\n` +
                      `### è©³ç´°\n` +
                      `| é …ç›® | å€¤ |\n` +
                      `|------|-----|\n` +
                      `| å®Ÿè¡Œæ—¥æ™‚ | ${new Date().toLocaleString('ja-JP')} |\n` +
                      `| ãƒ«ãƒ¼ãƒ—å›æ•° | ${loopCount}å› |\n` +
                      `| ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ | [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) |\n\n` +
                      `### å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n` +
                      `- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®š\n` +
                      `- [ ] æ‰‹å‹•ã§ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£\n` +
                      `- [ ] ä¿®æ­£å¾Œã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œã—ã¦ç¢ºèª\n\n` +
                      `---\n` +
                      `*ã“ã®Issueã¯è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ*`,
                labels: ['auto-repair', 'bug', 'needs-review']
              });
              console.log(`æ–°è¦Issue #${issue.data.number} ã‚’ä½œæˆ`);
            }

      - name: æˆåŠŸæ™‚ã‚µãƒãƒªãƒ¼
        if: success()
        run: |
          echo "## âœ… è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾© æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ«ãƒ¼ãƒ—å›æ•° | ${{ steps.repair_loop.outputs.loop_count }}å› |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¿®å¾©å®Ÿè¡Œ | ${{ steps.repair_loop.outputs.repairs_made }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ€çµ‚çŠ¶æ…‹ | å…¨ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¹ |" >> $GITHUB_STEP_SUMMARY

  notification:
    name: å®Ÿè¡Œçµæœé€šçŸ¥
    needs: error-detection-repair
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: çµæœã‚µãƒãƒªãƒ¼
        run: |
          echo "============================================="
          echo "  è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ å®Œäº†"
          echo "============================================="
          echo "ã‚¸ãƒ§ãƒ–çµæœ: ${{ needs.error-detection-repair.result }}"
          echo "æ¬¡å›å®Ÿè¡Œ: 30åˆ†å¾Œï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®å ´åˆï¼‰"
