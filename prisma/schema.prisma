// Personal Knowledge Base - Prisma Schema
// データベース: SQLite（シンプル・バックアップ容易）

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ノート（メモ）
model Note {
  id        String   @id @default(uuid())
  title     String
  content   String
  isPinned  Boolean  @default(false)
  isFavorite Boolean @default(false)
  isArchived Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  tags      NoteTag[]
  folder    Folder?   @relation(fields: [folderId], references: [id])
  folderId  String?
  attachments Attachment[]

  // Phase 3: ノート間リンク
  outgoingLinks NoteLink[] @relation("OutgoingLinks")
  incomingLinks NoteLink[] @relation("IncomingLinks")

  // インデックス
  @@index([title])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([folderId])
}

// タグ
model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  color     String?   // HEX color code
  createdAt DateTime  @default(now())

  notes     NoteTag[]

  @@index([name])
}

// ノートとタグの中間テーブル
model NoteTag {
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  noteId    String
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId     String
  createdAt DateTime @default(now())

  @@id([noteId, tagId])
}

// フォルダ（階層構造）
model Folder {
  id        String   @id @default(uuid())
  name      String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 自己参照リレーション
  parent    Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Folder[] @relation("FolderHierarchy")

  notes     Note[]

  @@index([parentId])
  @@index([name])
}

// 添付ファイル
model Attachment {
  id          String   @id @default(uuid())
  fileName    String
  filePath    String
  mimeType    String
  fileSize    Int
  createdAt   DateTime @default(now())

  note        Note?    @relation(fields: [noteId], references: [id], onDelete: Cascade)
  noteId      String?

  @@index([noteId])
}

// テンプレート
model Template {
  id        String   @id @default(uuid())
  name      String   @unique
  content   String
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([category])
}

// Phase 3: ノート間リンク
model NoteLink {
  id           String   @id @default(uuid())
  sourceNoteId String   // リンク元ノートID
  targetNoteId String   // リンク先ノートID
  linkText     String   // [[ノート名]] の「ノート名」部分
  context      String?  // リンク周辺コンテキスト（前後50文字）
  createdAt    DateTime @default(now())

  // リレーション
  sourceNote   Note     @relation("OutgoingLinks", fields: [sourceNoteId], references: [id], onDelete: Cascade)
  targetNote   Note     @relation("IncomingLinks", fields: [targetNoteId], references: [id], onDelete: Cascade)

  // インデックス
  @@index([sourceNoteId])
  @@index([targetNoteId])
  @@index([sourceNoteId, targetNoteId])
  @@unique([sourceNoteId, targetNoteId, linkText])
}
